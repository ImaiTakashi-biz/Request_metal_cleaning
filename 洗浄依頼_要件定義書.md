# 洗浄依頼 デスクトップアプリ 要件定義書

作成日: 2025-08-19

## 1. 目的

製造現場における洗浄依頼情報を、SQLite データベースと連携したデスクトップアプリで迅速に参照・更新できるようにする。
現場の優先度（洗浄指示番号）やセット状況の自動判定・色分け表示により、作業の見える化と判断速度を向上させる。

## 2. 対象範囲（スコープ）

* 本要件は Windows デスクトップで動作する単体アプリケーションに適用する。
* データ保存先は既存の SQLite データベース `cleaning_instructions.db` とする。
* 参照・更新するレコードは、アプリ内で選択した日付（acquisition\_date）に合致するものとする。

## 3. 関連システム・データベース

* SQLite DB: `\\192.168.1.200\共有\製造課\ロボパット\python app\cleaning_instructions.db`

## 4. 用語

* **洗浄指示番号**: 1〜4 または空白（無指定）。UI 上の行背景色や優先度に利用。
* **セット**: 現場でのセット作業対応フラグ（DB には列が無いアプリ内チェック）。
* **acquisition\_date**: レコードの対象日。アプリで選択した日付に一致するレコードを抽出。

## 5. 画面要件（UI/UX）

### 5.1 画面構成

* **ヘッダー（列）**（左からの想定。括弧内は DB カラム名）

  * セット日（非表示） … `set_date`
  * 加工終了日（非表示） … `completion_date`
  * 機番 … `machine_no`
  * 製造check（チェックボックス） … `manufacturing_check`
  * 洗浄check（チェックボックス） … `cleaning_check`
  * セット（チェックボックス／アプリ内のみ、DBに列無し）
  * 品番 … `part_number`
  * 品名 … `product_name`
  * 客先名 … `customer_name`
  * 次工程 … `next_process`
  * 備考（ドロップダウン＋自由入力） … 候補:「出荷無し」「1st外観」
  * 洗浄指示（選択） … `cleaning_instruction`（値: 1 / 2 / 3 / 4 / 空白）

* **フィルタパネル**

  * 日付選択（カレンダー）: `acquisition_date` を日付一致で抽出
  * 文字検索（任意）: 品番/品名/客先名 など部分一致

* **ステータス表示**

  * 抽出件数、未チェック件数 などをステータスバーに表示

### 5.2 色分けルール

* **行の背景色（洗浄指示に基づく）**

  * 1: 赤
  * 2: ピンク
  * 3: 青
  * 4: 黄色
  * 空白: 既定色（無着色）

* **セット チェックボックスの背景色（自動判定結果）**

  * 条件: 「セット日が昨日」かつ「加工終了日が今日」 → 青
  * 条件: 「セット日が昨日」かつ「加工終了日が今日以外」 → 黄色
  * 上記以外 → 既定色（無着色）

### 5.3 洗浄指示番号の説明（ヘルプ）

* 1: 急ぎ・当日出荷（AM10:30までに洗浄）
* 2: 近日中に出荷（AM中に洗浄）
* 3: 通常品（当日中に洗浄）
* 4: サビ注意品・別途指示品

## 6. 振る舞い（ビジネスロジック）

1. アプリ起動時、当日または直近選択状態で `acquisition_date` に一致するレコードを抽出し一覧に表示。
2. 洗浄指示番号に応じて行背景色を適用。
3. セット自動判定：

   * セット日（`set_date`）が「昨日」の場合、アプリ内「セット」チェックを自動で ON（TRUE）。
   * さらに、加工終了日（`completion_date`）が「今日」なら「セット」チェック背景＝青、
     それ以外なら「セット」チェック背景＝黄色。
4. 備考はドロップダウン（「出荷無し」「1st外観」）のいずれか + 任意コメント入力を許可。
5. 製造check / 洗浄check はチェックボックスで更新可能。
6. 洗浄指示（`cleaning_instruction`）は 1 / 2 / 3 / 4 / 空白 の中から選択。
7. レコード更新時は即時に SQLite へ反映し、楽観ロック相当の更新時刻検証（`updated_at` 列がある場合）を実施。

## 7. データ項目定義

| 表示名     | DBカラム                 | 型/候補            | 必須 | 備考                 |
| ------- | --------------------- | --------------- | -- | ------------------ |
| セット日    | set\_date             | DATE            | 任意 | 非表示                |
| 加工終了日   | completion\_date      | DATE            | 任意 | 非表示                |
| 機番      | machine\_no           | TEXT            | 任意 |                    |
| 製造check | manufacturing\_check  | BOOLEAN         | 任意 | 0/1                |
| 洗浄check | cleaning\_check       | BOOLEAN         | 任意 | 0/1                |
| セット     | （なし）                  | BOOLEAN         | 算出 | アプリ内のみ             |
| 品番      | part\_number          | TEXT            | 任意 |                    |
| 品名      | product\_name         | TEXT            | 任意 |                    |
| 客先名     | customer\_name        | TEXT            | 任意 |                    |
| 次工程     | next\_process         | TEXT            | 任意 |                    |
| 備考      | notes 等             | TEXT            | 任意 | 「出荷無し」「1st外観」＋コメント |
| 洗浄指示    | cleaning\_instruction | INTEGER or TEXT | 任意 | 1/2/3/4/空白         |
| 取得日     | acquisition\_date     | DATE            | 必須 | フィルタキー             |

## 8. フィルタ仕様

* カレンダーで選択した日付（例: 2025/08/19）に一致する `acquisition_date`（例: 2025-08-19）の行のみ表示。
* UI と DB で日付フォーマットが異なる場合はアプリ側で正規化する（ローカルタイムゾーン: Asia/Tokyo を前提）。

## 9. 入力制御・バリデーション

* 洗浄指示: 1/2/3/4/空白 以外は選べない UI とする。
* 備考: リスト値と自由入力を併用可能。危険記号（改行、極端に長い文字列等）は制限。
* 日付: 不正日付は保存不可。

## 10. 役割・権限（任意拡張）

* 現場担当: 参照・チェック更新・備考入力
* 監督者: すべて更新可能
* 監査ログ: 主要変更（チェック、洗浄指示、備考）を記録（任意）

## 11. 非機能要件

* **性能**: 1,000 行程度を即時描画できること。更新は 0.5 秒以内を目標。
* **可用性**: DB パス未接続時は読み取り専用で起動し、再接続機能を提供。
* **ログ**: アプリログ（INFO/ERROR）をローカルに出力。
* **バージョン管理**: アプリのビルド番号と DB スキーマの互換性を起動時に検査。

## 12. 例外・エラー処理

* DB 接続不可: UNC パスを再試行/再設定できるダイアログを表示。
* 競合: 保存前に再読込して差分解決（`updated_at` が無い場合は最終勝ちで保存）。
* 入力不正: フィールド単位でエラー表示。

## 13. デプロイ・運用

* 配布形態: 単一 EXE（Python + PyInstaller など）または MSIX。
* 設定ファイル: `config.json`（DB パス、既定表示日、色コード等）。
* 自動更新: 任意（社内共有フォルダから起動する運用でも可）。

## 14. テスト観点（抜粋）

* acquisition\_date フィルタ一致の検証（フォーマット差異含む）。
* 洗浄指示番号ごとの背景色適用。
* セット自動判定（昨日/今日ロジック）の境界条件（時刻跨ぎ）。
* チェックボックス更新の DB 反映。
* 備考のプリセット＋自由入力の保存。
* 接続断復旧時の再接続。

## 15. 受け入れ条件（サンプル）

1. 日付フィルタで選択した日のレコードのみが表示されること。
2. 洗浄指示番号 1〜4/空白に応じて行背景色が仕様通りになること。
3. セット日が「昨日」の行で、加工終了日が「今日」= 青、今日以外= 黄 で表示されること。
4. 製造/洗浄チェックや備考/洗浄指示の変更が DB に反映されること。
5. DB 未接続時の適切なエラーメッセージと再接続手段が提供されること。

## 16. 将来拡張（任意）

* ステータス別集計（今日/今週の急ぎ件数など）。
* 通知（締切前リマインド）。
* 監査ログと変更履歴の画面表示。

---

### 付録A: 色設定例（任意・設定で上書き可能）

* 指示1: `#FF0000`（赤）
* 指示2: `#FFC0CB`（ピンク）
* 指示3: `#0000FF`（青）
* 指示4: `#FFFF00`（黄色）

### 付録B: 参考クエリ

```sql
-- 指定日の抽出（例: 2025-08-19）
SELECT *
FROM main_table
WHERE acquisition_date = '2025-08-19';
```